# Plan 03-01: File Reading

## Goal

Read dropped file content, detect text vs binary, handle encoding. Files added to context store will have their actual content populated for AI consumption.

## Why This Approach

Using the browser's File API and FileReader:
- `FileReader.readAsText()` for text files with UTF-8 encoding
- Check for binary content by detecting null bytes
- Skip binary files (images, executables, etc.)
- Filter by file extension to exclude obviously binary files

## Tasks

### Task 1: Create file reading utility

Create `src/utils/fileReader.ts` with functions to:
1. Read file content as text
2. Detect if content is binary (contains null bytes)
3. Filter files by extension (exclude images, executables, etc.)

**Implementation:**

```typescript
// Binary file extensions to skip
const BINARY_EXTENSIONS = new Set([
  'png', 'jpg', 'jpeg', 'gif', 'webp', 'ico', 'svg',
  'pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx',
  'zip', 'tar', 'gz', 'rar', '7z',
  'exe', 'dll', 'so', 'dylib',
  'mp3', 'mp4', 'wav', 'avi', 'mov',
  'woff', 'woff2', 'ttf', 'eot', 'otf',
  'bin', 'dat',
])

export function isBinaryExtension(filename: string): boolean {
  const ext = filename.split('.').pop()?.toLowerCase() || ''
  return BINARY_EXTENSIONS.has(ext)
}

export function readFileAsText(file: File): Promise<string> {
  return new Promise((resolve, reject) => {
    const reader = new FileReader()
    reader.onload = () => resolve(reader.result as string)
    reader.onerror = () => reject(new Error(`Failed to read file: ${file.name}`))
    reader.readAsText(file, 'UTF-8')
  })
}

export function containsBinaryContent(content: string): boolean {
  // Check for null bytes which indicate binary content
  return content.includes('\0')
}

export interface ReadFileResult {
  success: boolean
  content: string
  error?: string
  isBinary?: boolean
}

export async function readTextFile(file: File): Promise<ReadFileResult> {
  // Skip files with binary extensions
  if (isBinaryExtension(file.name)) {
    return { success: false, content: '', isBinary: true, error: 'Binary file skipped' }
  }

  try {
    const content = await readFileAsText(file)

    // Check if content appears to be binary
    if (containsBinaryContent(content)) {
      return { success: false, content: '', isBinary: true, error: 'Binary content detected' }
    }

    return { success: true, content }
  } catch (error) {
    return {
      success: false,
      content: '',
      error: error instanceof Error ? error.message : 'Unknown error'
    }
  }
}
```

**Verification:**
- [x] File created at `src/utils/fileReader.ts`
- [x] Binary extension detection works
- [x] Text file reading works
- [x] Binary content detection works

### Task 2: Update ChatPanel to read file content

Update `handleFilesDropped` to:
1. Import and use `readTextFile`
2. Read actual content before adding to store
3. Skip binary files with appropriate feedback

**Updated handler:**

```typescript
import { readTextFile } from '@/utils/fileReader'

async function handleFilesDropped(files: File[]) {
  for (const file of files) {
    const result = await readTextFile(file)

    if (!result.success) {
      // Skip binary files silently (or show toast in future)
      continue
    }

    contextStore.addFile({
      name: file.name,
      path: file.name,
      content: result.content,
      language: detectLanguage(file.name),
      size: result.content.length,
      source: ContextSource.LOCAL,
    })
  }
}
```

**Verification:**
- [x] Files are read before adding to store
- [x] Content is populated in context store
- [x] Binary files are skipped
- [x] No TypeScript errors

## Verification

After completing both tasks:

1. **Type check passes:**
   ```bash
   npm run type-check
   ```

2. **Manual testing:**
   - Start dev server: `npm run dev`
   - Drag a .ts file onto chat input
   - Use Vue DevTools to verify content is in context store
   - Drag an image file - should be skipped

## Estimated Scope

- **Task 1:** ~40 lines (utility functions)
- **Task 2:** ~15 lines (update handler)
- **Total:** ~55 lines
