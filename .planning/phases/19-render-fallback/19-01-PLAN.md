---
phase: 19-render-fallback
plan: 01
type: execute
---

<objective>
Automatically switch to ASCII sidecar view when Mermaid rendering fails.

Purpose: Provide a seamless fallback experience so users always see diagram content, even when rendering fails.
Output: Enhanced DiagramBlockRenderer with auto-fallback and improved error UX.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior phase (sidecar display):**
@.planning/phases/16-sidecar-display/16-01-SUMMARY.md

**Key files:**
@src/components/chat/DiagramBlockRenderer.vue - Main component to enhance
@src/composables/useMermaid.ts - Provides error state

**Tech stack available:** Vue 3 Composition API, useMermaid composable
**Established patterns:** View toggle (diagram/ascii/code), error ref from useMermaid

**Current behavior (from Phase 16):**
- DiagramBlockRenderer has 3 view modes: diagram, ascii, code
- When render fails, error message shown with ASCII fallback displayed BELOW error
- No automatic tab switch occurs
- User must manually understand error and switch to ASCII tab

**What this phase adds:**
- Auto-switch to ASCII tab when render fails (if sidecar exists)
- Better error UX for cases without sidecar
- Visual indicator when viewing fallback
</context>

<tasks>

<task type="auto">
  <name>Task 1: Auto-switch to ASCII on render failure</name>
  <files>src/components/chat/DiagramBlockRenderer.vue</files>
  <action>
Modify DiagramBlockRenderer to automatically switch viewMode to 'ascii' when:
1. Mermaid rendering fails (error becomes truthy)
2. A sidecar exists for the block

Implementation:
1. Add a `watch` on `error` ref from useMermaid
2. When error becomes truthy AND `props.block.sidecar` exists, set `viewMode.value = 'ascii'`
3. Add a ref `isFallbackMode` to track that we're showing fallback (not user choice)
4. Show a subtle info message in ASCII view when in fallback mode: "Showing ASCII fallback (diagram rendering failed)"

The existing error display in diagram view can be simplified since we auto-switch away.

Keep the error message visible briefly OR just switch silently - user sees ASCII which is the desired fallback.
  </action>
  <verify>
1. Manually create a DiagramBlock with invalid mermaid code and valid sidecar
2. Confirm it auto-switches to ASCII tab
3. Confirm fallback indicator shows
  </verify>
  <done>
- Render failure with sidecar auto-switches to ASCII view
- Fallback indicator visible when in fallback mode
  </done>
</task>

<task type="auto">
  <name>Task 2: Improve error UX for no-sidecar case</name>
  <files>src/components/chat/DiagramBlockRenderer.vue</files>
  <action>
Enhance the error state when render fails but NO sidecar exists:

1. Keep user on diagram view (no ASCII to switch to)
2. Show improved error message with actionable guidance:
   - "Diagram rendering failed: [error message]"
   - "View the Code tab to see the raw Mermaid syntax"
3. Style the error state to be clear but not alarming:
   - Error icon or badge
   - Muted background
   - Clear call-to-action

This ensures users without sidecar fallback still have a path forward (debug via Code tab).
  </action>
  <verify>
1. Create DiagramBlock with invalid mermaid and NO sidecar
2. Confirm stays on diagram view with improved error message
3. Confirm "View Code tab" suggestion is visible
  </verify>
  <done>
- No-sidecar failures show helpful error with Code tab suggestion
- Error state is styled clearly
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run type-check` passes
- [ ] `npm run build` succeeds
- [ ] Render failure WITH sidecar auto-switches to ASCII
- [ ] Render failure WITHOUT sidecar shows helpful error
- [ ] Fallback indicator visible in ASCII fallback mode
</verification>

<success_criteria>
- Auto-fallback to ASCII when render fails (if sidecar exists)
- Improved error UX when no sidecar available
- Type check and build pass
- Seamless user experience - users always see useful content
</success_criteria>

<output>
After completion, create `.planning/phases/19-render-fallback/19-01-SUMMARY.md`
</output>
