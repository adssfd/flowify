---
phase: 13-mermaid-skill-prompt
plan: 01
type: execute
---

<objective>
Inject the Mermaid Diagrams Skill into AI system prompts so the AI follows compatibility rules and generates ASCII sidecars.

Purpose: AI will generate renderer-compatible Mermaid diagrams with human-readable text fallbacks, improving diagram quality across all platforms (VS Code, GitHub, etc.)
Output: Updated `buildSystemPrompt()` method with Mermaid skill rules
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/references/mermaid-skill.md

**Source files:**
@src/services/ai/base.ts

**Established patterns:**
- AI service base class with `buildSystemPrompt()` method
- System prompt includes diagram context and codebase context
- No external dependencies needed

**Key decisions:**
- Mermaid skill rules go directly into system prompt (not as separate file)
- Keep skill content concise but complete - AI can follow detailed rules
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update buildSystemPrompt with Mermaid skill</name>
  <files>src/services/ai/base.ts</files>
  <action>
Replace the `buildSystemPrompt()` method content to include the Mermaid Diagrams Skill rules.

The updated prompt MUST include:
1. **Compatibility rules:**
   - Prefer `graph LR`/`graph TB` over `flowchart` keyword
   - Quote labels with spaces/special characters: `A["Text"]`
   - Use `<br/>` for line breaks, never literal `\n` in labels
   - Fallbacks for advanced types (quadrantChart, sankey-beta, gitGraph)

2. **ASCII sidecar requirement:**
   - MUST include text-only diagram right under each Mermaid block
   - Use fenced code with language `text`
   - Keep width ~80 columns
   - Use simple ASCII primitives: `[Name]`, `-->`, `{cond?}`

3. **Diagram type guidance:**
   - Flowchart: flows, decisions, data movement
   - Sequence: actor/service interactions over time
   - Class: domain models, static structure
   - State: lifecycle, state machines
   - ER: database models with cardinalities
   - Journey: user experience across steps
   - Gantt: scheduling, timelines
   - Pie: simple ratios

4. **Example format in prompt** (so AI learns the pattern):
   Show a compact example of Mermaid + ASCII sidecar pair

Keep the existing codebaseContext and current diagram context sections.
Structure the prompt clearly with section headers.
  </action>
  <verify>npm run type-check passes</verify>
  <done>buildSystemPrompt() includes Mermaid skill rules with compatibility rules, ASCII sidecar requirement, and diagram type guidance</done>
</task>

<task type="auto">
  <name>Task 2: Verify build</name>
  <files>N/A</files>
  <action>
Run full type-check and build to ensure no regressions.
  </action>
  <verify>npm run type-check && npm run build</verify>
  <done>Type check passes, build succeeds with no errors</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run type-check` passes
- [ ] `npm run build` succeeds
- [ ] `buildSystemPrompt()` includes all Mermaid skill sections
- [ ] Prompt structure is clear with section headers
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors introduced
- System prompt includes:
  - Compatibility rules (graph vs flowchart, quoting, br tags)
  - ASCII sidecar requirement with format
  - Diagram type guidance
  - Example Mermaid + sidecar pair
</success_criteria>

<output>
After completion, create `.planning/phases/13-mermaid-skill-prompt/13-01-SUMMARY.md`
</output>
