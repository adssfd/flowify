# Plan 07-01: GitHub API

## Goal

Fetch file contents from public GitHub repos via API. When a user pastes a GitHub URL, fetch the repository contents and add files to context.

## Why This Approach

Using GitHub's public API:
- `GET /repos/{owner}/{repo}/git/trees/{branch}?recursive=1` - Get full file tree
- `GET /repos/{owner}/{repo}/contents/{path}` - Get file content

Rate limits for unauthenticated requests: 60/hour (sufficient for occasional use).

Strategy:
1. Fetch file tree to get list of all files
2. Filter to text files only (by extension)
3. Fetch file contents (respecting size limits)
4. Add to context store

## Tasks

### Task 1: Create GitHub API service

Create `src/services/github.ts`:

```typescript
import type { GitHubRepo, ContextFile } from '@/types'
import { ContextSource, ContextLoadingState } from '@/types'
import { isBinaryExtension } from '@/utils/fileReader'

interface GitHubTreeItem {
  path: string
  type: 'blob' | 'tree'
  size?: number
}

interface GitHubTreeResponse {
  tree: GitHubTreeItem[]
  truncated: boolean
}

const MAX_FILE_SIZE = 100 * 1024 // 100KB per file
const MAX_TOTAL_SIZE = 500 * 1024 // 500KB total

export async function fetchGitHubRepo(repo: GitHubRepo): Promise<Omit<ContextFile, 'id' | 'addedAt'>[]> {
  // Fetch tree
  const treeUrl = `https://api.github.com/repos/${repo.owner}/${repo.repo}/git/trees/${repo.branch}?recursive=1`
  const treeResponse = await fetch(treeUrl)

  if (!treeResponse.ok) {
    throw new Error(`Failed to fetch repository: ${treeResponse.status}`)
  }

  const treeData: GitHubTreeResponse = await treeResponse.json()

  // Filter to text files within size limit
  const textFiles = treeData.tree.filter(item =>
    item.type === 'blob' &&
    !isBinaryExtension(item.path) &&
    (item.size ?? 0) < MAX_FILE_SIZE
  )

  // Fetch file contents (limited by total size)
  const files: Omit<ContextFile, 'id' | 'addedAt'>[] = []
  let totalSize = 0

  for (const item of textFiles) {
    if (totalSize >= MAX_TOTAL_SIZE) break

    const contentUrl = `https://api.github.com/repos/${repo.owner}/${repo.repo}/contents/${item.path}?ref=${repo.branch}`
    const contentResponse = await fetch(contentUrl)

    if (!contentResponse.ok) continue

    const contentData = await contentResponse.json()
    const content = atob(contentData.content) // Base64 decode

    files.push({
      name: item.path.split('/').pop() || item.path,
      path: item.path,
      content,
      language: detectLanguage(item.path),
      size: content.length,
      source: ContextSource.GITHUB,
    })

    totalSize += content.length
  }

  return files
}
```

**Verification:**
- [x] File created at `src/services/github.ts`
- [x] Fetches repo tree
- [x] Filters binary files
- [x] Respects size limits

### Task 2: Update ChatPanel to fetch GitHub repos

Update handleGitHubUrl to trigger fetching:

```typescript
import { fetchGitHubRepo } from '@/services/github'

async function handleGitHubUrl(url: string) {
  const repo = parseGitHubUrl(url)
  if (!repo) return

  contextStore.setGitHubRepo(repo)
  contextStore.setLoading(ContextLoadingState.LOADING)

  try {
    const files = await fetchGitHubRepo(repo)
    contextStore.addFiles(files)
    contextStore.setLoading(ContextLoadingState.IDLE)
  } catch (error) {
    const message = error instanceof Error ? error.message : 'Failed to fetch repository'
    contextStore.setError(message)
  }
}
```

**Verification:**
- [x] Fetching triggered on URL paste
- [x] Loading state shown
- [x] Files added to store
- [x] Errors handled

### Task 3: Show loading state in ContextIndicator

Update ContextIndicator to show loading and GitHub repo info:

```vue
<div v-if="contextStore.loadingState === ContextLoadingState.LOADING" class="loading-state">
  Loading repository...
</div>
<div v-if="contextStore.githubRepo" class="github-badge">
  {{ contextStore.githubRepo.owner }}/{{ contextStore.githubRepo.repo }}
</div>
```

**Verification:**
- [x] Loading indicator shown during fetch
- [x] GitHub repo badge displayed
- [x] Error message shown if fetch fails

## Verification

After completing all tasks:

1. **Type check passes:**
   ```bash
   npm run type-check
   ```

2. **Manual testing:**
   - Paste `https://github.com/vuejs/petite-vue` (small repo)
   - Verify loading state shows
   - Verify files appear in context
   - Test error handling with invalid URL

## Estimated Scope

- **Task 1:** ~60 lines (API service)
- **Task 2:** ~20 lines (ChatPanel update)
- **Task 3:** ~30 lines (ContextIndicator update)
- **Total:** ~110 lines
