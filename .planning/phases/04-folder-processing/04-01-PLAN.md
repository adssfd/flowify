# Plan 04-01: Folder Processing

## Goal

Handle folder drops, recursively read contents, filter by file type. When a user drops a folder, read all text files within it and add to context.

## Why This Approach

Using the DataTransferItem.webkitGetAsEntry() API for folder access:
- This is the standard way to handle folder drops in browsers
- Provides recursive directory traversal
- Works in Chrome, Firefox, Edge, Safari

The approach:
1. Check if dropped item is a directory via webkitGetAsEntry()
2. Recursively read directory entries
3. Read each file and add to context store
4. Skip binary files using existing fileReader utility

## Tasks

### Task 1: Create folder reading utility

Add folder processing functions to `src/utils/fileReader.ts`:

```typescript
interface FileSystemEntryLike {
  isFile: boolean
  isDirectory: boolean
  name: string
  file?: (success: (file: File) => void, error?: (err: Error) => void) => void
  createReader?: () => { readEntries: (success: (entries: FileSystemEntryLike[]) => void, error?: (err: Error) => void) => void }
}

export async function readDirectory(entry: FileSystemEntryLike): Promise<File[]> {
  const files: File[] = []

  if (entry.isFile && entry.file) {
    return new Promise((resolve, reject) => {
      entry.file!((file) => resolve([file]), reject)
    })
  }

  if (entry.isDirectory && entry.createReader) {
    const reader = entry.createReader()
    const entries = await new Promise<FileSystemEntryLike[]>((resolve, reject) => {
      reader.readEntries(resolve, reject)
    })

    for (const childEntry of entries) {
      const childFiles = await readDirectory(childEntry)
      files.push(...childFiles)
    }
  }

  return files
}

export function getEntriesFromDataTransfer(dataTransfer: DataTransfer): FileSystemEntryLike[] {
  const entries: FileSystemEntryLike[] = []
  const items = dataTransfer.items

  for (let i = 0; i < items.length; i++) {
    const item = items[i]
    const entry = item.webkitGetAsEntry?.() as FileSystemEntryLike | null
    if (entry) {
      entries.push(entry)
    }
  }

  return entries
}
```

**Verification:**
- [x] Functions added to fileReader.ts
- [x] Recursive directory reading works
- [x] Handles both files and folders

### Task 2: Update ChatInput to detect folders

Update ChatInput's drop handler to pass DataTransfer instead of just files:

```typescript
// Update emit
interface Emits {
  (e: 'files-dropped', files: File[]): void
  (e: 'data-dropped', dataTransfer: DataTransfer): void
}

function handleDrop(event: DragEvent) {
  event.preventDefault()
  event.stopPropagation()
  isDragging.value = false

  const dataTransfer = event.dataTransfer
  if (dataTransfer) {
    emit('data-dropped', dataTransfer)
  }
}
```

**Verification:**
- [x] data-dropped event emitted with DataTransfer
- [x] ChatInput updated

### Task 3: Update ChatPanel to handle folders

Update ChatPanel to process folders:

```typescript
import { readTextFile, getEntriesFromDataTransfer, readDirectory } from '@/utils/fileReader'

async function handleDataDropped(dataTransfer: DataTransfer) {
  const entries = getEntriesFromDataTransfer(dataTransfer)

  // If no entries (fallback for browsers without webkitGetAsEntry)
  if (entries.length === 0) {
    const files = Array.from(dataTransfer.files)
    await processFiles(files)
    return
  }

  // Process entries (can include folders)
  for (const entry of entries) {
    const files = await readDirectory(entry)
    await processFiles(files, entry.name)
  }
}

async function processFiles(files: File[], basePath = '') {
  for (const file of files) {
    const result = await readTextFile(file)
    if (!result.success) continue

    const path = basePath ? `${basePath}/${file.name}` : file.name

    contextStore.addFile({
      name: file.name,
      path,
      content: result.content,
      language: detectLanguage(file.name),
      size: result.content.length,
      source: ContextSource.LOCAL,
    })
  }
}
```

**Verification:**
- [x] Folder drops process all files recursively
- [x] File paths include folder structure
- [x] No TypeScript errors

## Verification

After completing all tasks:

1. **Type check passes:**
   ```bash
   npm run type-check
   ```

2. **Manual testing:**
   - Drop a folder with .ts files
   - Verify all files appear in context store
   - Verify paths include folder structure

## Estimated Scope

- **Task 1:** ~40 lines (folder reading)
- **Task 2:** ~10 lines (ChatInput update)
- **Task 3:** ~30 lines (ChatPanel handler)
- **Total:** ~80 lines
